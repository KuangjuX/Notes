# 并行性和局部性优化

本篇是学习《编译原理》第 11 章所做的笔记。

**仿射函数**通常被称为线性函数，例如 $ Z[i][j] $ 和 $ Z[i][i + j] $ 都是仿射访问。贲张给出的理论基于线性代数和整数规划技术，把一个深度为 n 的嵌套循环结构中的迭代建模为一个 n 维多面体，该多面体的边界可以用代码中循环的界限来描述。

## 仿射变换原理

基本概念：
- 迭代空间： 循环的迭代的集合。
- 数据空间
- 处理器空间
- 仿射数组下标函数： 代码中的每个数组访问都描述了一个从迭代空间中的迭代到数据空间中的数组元素的映射。
- 仿射分划： 使用一个仿射函数把一个迭代空间中的各个迭代分配给处理器空间中的各个处理器，由此把一个循环并行化。
- 被访问数据的区域：知道一个迭代所访问数据的区域有助于找到最好的仿射分划。
- 数据依赖

### 迭代空间

**不等式组的矩阵表示方法**

在一个深度为 d 的循环嵌套中的迭代可以用数学方式表示为：

$$
\{i 在 Z^d 中｜Bi + b \geq 0\}
$$

- $ Z $ 表示整数的集合
- $ B $ 是一个 $ d \times d $ 的整数矩阵 
- $ b $ 是一个长度为 $ d $ 的整数向量
- $ 0 $ 是一个由 $ d $ 个 $ 0 $ 组成的向量

一个例子为：

$$
\begin{bmatrix}
-1 & 0 \\
-1 & 0 \\
-1 & 1 \\
0 & -1
\end{bmatrix}

\begin{bmatrix}
i \\
j
\end{bmatrix}

+ 
\begin{bmatrix}
0 \\
5 \\
0 \\
7
\end{bmatrix}


\geq 


\begin{bmatrix}
0 \\
0 \\
0 \\
0
\end{bmatrix}
$$

**混合使用符号常量**

有时需要对涉及某些变量的乔套循环进行优化，这些变量对于嵌套中的所有循环都是循环不变的。这样的变量称为**符号常量(symbolic constant)**。但为了描述一个迭代空间的边界，需要把它们当作变量进行处理，并在循环下标变量组成的向量中为它们创建一个条目。

例如 

```
for(i = 0; i <= n; i++){
    ...
}
```

可以被描述为:

$$
\{

i 在 Z 中 ｜ 

\begin{bmatrix}
-1 & 1 \\ 
1 & 0 \\
\end{bmatrix}

\begin{bmatrix}
i \\
n 
\end{bmatrix}

\geq 

\begin{bmatrix}
0 \\
0
\end{bmatrix}

\}
$$


**控制执行的顺序**

从一个循环体的上下界中抽取到的线性不等式定义了一个凸多面体上的迭代的集合。但这个表示方法并没有假定在迭代空间中的迭代之间的任何执行顺序。源程序在迭代之上强加了一个串行，按顺序就是按照从外到内方式排列的循环下标变量取值的字典排序，但只要遵守它们之间的数据依赖关系，就可以按照任何顺序执行该空间中的迭代。

**给定一个凸多面体和一个下标变量的排序，我们该如何生成循环的界限，是得循环能够按照这些变量的字典排序扫描这个迭代空间？**

**投影**

从几何学的角度讲可以把表示迭代空间的凸多面体投影(projectint)到该空间中对英语较外层循环的维度中，以得到一个深度为 2 的循环嵌套结构中外层循环下标变量的循环界限。

**Four-Motzkin 消除算法**

对于 C 中关于 $x_m$ 的每一对上界和下界，比如：

$$
L \leq c_1x_m, \\
c_2x_m \leq U, \\

$$

建立一个新的约束：


$$
c_2L \leq c_1U
$$

随后可以生成循环边界来便利一个凸多面体，按照从最内层到最外层循环的顺序计算循环边界。所有涉及最内层循环下标变量的不等式都被改写成为该变量的上下界形式，最后通过投影消除代表最内层循环的维度。

**坐标轴的变换**

对迭代空间进行水平扫描和垂直扫描是最常见的访问迭代空间的办法。还有其他可行方法，例如按照斜线扫描迭代空间。定义 $k=j-1$，并按照针对 k, j 的字典顺序扫描上面的迭代空间。在不等式中使用 $j-k$代替 $i$。


### 仿射的数组下标
